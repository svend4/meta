"""
hexwuxing.py ‚Äî ‰∫îË°å W«î X√≠ng: –ü—è—Ç—å –ü–µ—Ä–≤–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º–∞—Ö Q6

–ö–∞–∂–¥–∞—è –∏–∑ –≤–æ—Å—å–º–∏ —Ç—Ä–∏–≥—Ä–∞–º–º —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —Å–≤—è–∑–∞–Ω–∞ —Å –æ–¥–Ω–∏–º –∏–∑ –ø—è—Ç–∏ –ø–µ—Ä–≤–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
–ø–æ —Å–∏—Å—Ç–µ–º–µ –ü–æ–∑–¥–Ω–µ–Ω–µ–±–µ—Å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è (ÂæåÂ§© H√≤u TiƒÅn, –∫–≤–∞–¥—Ä–∞—Ç –õ–æ-–®—É):

  ‚ò≥ –ß–∂—ç–Ω—å (–í)   ‚Üí Êú® –î–µ—Ä–µ–≤–æ
  ‚ò¥ –°—é–Ω—å  (–Æ–í)  ‚Üí Êú® –î–µ—Ä–µ–≤–æ
  ‚ò≤ –õ–∏    (–Æ)   ‚Üí ÁÅ´ –û–≥–æ–Ω—å
  ‚ò∑ –ö—É–Ω—å  (–Æ–ó)  ‚Üí Âúü –ó–µ–º–ª—è
  ‚ò∂ –ì—ç–Ω—å  (–°–í)  ‚Üí Âúü –ó–µ–º–ª—è
  ‚ò∞ –¶—è–Ω—å  (–°–ó)  ‚Üí Èáë –ú–µ—Ç–∞–ª–ª
  ‚ò± –î—É–π   (–ó)   ‚Üí Èáë –ú–µ—Ç–∞–ª–ª
  ‚òµ –ö–∞–Ω—å  (–°)   ‚Üí Ê∞¥ –í–æ–¥–∞

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¶–ò–ö–õ –ü–û–†–û–ñ–î–ï–ù–ò–Ø (Áõ∏Áîü XiƒÅng Shƒìng):
  –î–µ—Ä–µ–≤–æ ‚Üí –û–≥–æ–Ω—å ‚Üí –ó–µ–º–ª—è ‚Üí –ú–µ—Ç–∞–ª–ª ‚Üí –í–æ–¥–∞ ‚Üí –î–µ—Ä–µ–≤–æ

–¶–ò–ö–õ –ü–û–î–ê–í–õ–ï–ù–ò–Ø (Áõ∏ÂÖã XiƒÅng K√®):
  –î–µ—Ä–µ–≤–æ ‚Üí –ó–µ–º–ª—è ‚Üí –í–æ–¥–∞ ‚Üí –û–≥–æ–Ω—å ‚Üí –ú–µ—Ç–∞–ª–ª ‚Üí –î–µ—Ä–µ–≤–æ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ö–∞–∂–¥–∞—è –∏–∑ 64 –≥–µ–∫—Å–∞–≥—Ä–∞–º–º = –Ω–∏–∂–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ + –≤–µ—Ä—Ö–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞.
–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–∞—ë—Ç –ü–Ø–¢–¨ –î–ò–ù–ê–ú–ò–ö:

  ÂêåÊ∞£ –¢√≥ng Q√¨   ‚Äî –ï–¥–∏–Ω—Å—Ç–≤–æ:    –Ω–∏–∂–Ω. = –≤–µ—Ä—Ö–Ω. (14 –≥–µ–∫—Å.)
  Áîü   Shƒìng     ‚Äî –†–æ–∂–¥–µ–Ω–∏–µ:    –Ω–∏–∂–Ω. –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –≤–µ—Ä—Ö–Ω. (12 –≥–µ–∫—Å.)
  ÂèçÁîü F«én Shƒìng ‚Äî –ü–∏—Ç–∞–Ω–∏–µ:     –≤–µ—Ä—Ö–Ω. –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –Ω–∏–∂–Ω. (12 –≥–µ–∫—Å.)
  ÂÖã   K√®        ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:  –Ω–∏–∂–Ω. –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤–µ—Ä—Ö–Ω. (13 –≥–µ–∫—Å.)
  ÂèçÂÖã F«én K√®    ‚Äî –ü—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: –≤–µ—Ä—Ö–Ω. –ø–æ–¥–∞–≤–ª—è–µ—Ç –Ω–∏–∂–Ω. (13 –≥–µ–∫—Å.)
"""

import sys
import os
import argparse
from collections import defaultdict

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../../libs/hexcore"))
from hexcore import yang_count

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../hexiching"))
from hexiching import Hexagram

RESET = "\033[0m"
BOLD  = "\033[1m"
DIM   = "\033[2m"
YANG_ANSI = {
    0: "\033[90m", 1: "\033[94m", 2: "\033[96m",
    3: "\033[92m", 4: "\033[93m", 5: "\033[95m", 6: "\033[97m",
}
GRN  = "\033[92m"
RED  = "\033[91m"
YLW  = "\033[93m"
BLU  = "\033[94m"
CYN  = "\033[96m"
MAG  = "\033[95m"
WHT  = "\033[97m"

# ---------------------------------------------------------------------------
# –î–∞–Ω–Ω—ã–µ: –ø—è—Ç—å –ø–µ—Ä–≤–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
# ---------------------------------------------------------------------------

ELEM_ID = {"wood": 0, "fire": 1, "earth": 2, "metal": 3, "water": 4}

ELEM_DATA = [
    {"name_cn": "Êú® –î–µ—Ä–µ–≤–æ", "name": "wood",  "sym": "‚òò",
     "ansi": "\033[92m",  "trig_h": [1, 6],   "dir": "–í/–Æ–í"},  # Zhen, Xun
    {"name_cn": "ÁÅ´ –û–≥–æ–Ω—å",  "name": "fire",  "sym": "üî•",
     "ansi": "\033[91m",  "trig_h": [5],       "dir": "–Æ"},    # Li
    {"name_cn": "Âúü –ó–µ–º–ª—è",  "name": "earth", "sym": "‚¨õ",
     "ansi": "\033[93m",  "trig_h": [0, 4],   "dir": "–Æ–ó/–°–í"}, # Kun, Gen
    {"name_cn": "Èáë –ú–µ—Ç–∞–ª–ª", "name": "metal", "sym": "‚óà",
     "ansi": "\033[97m",  "trig_h": [7, 3],   "dir": "–°–ó/–ó"},  # Qian, Dui
    {"name_cn": "Ê∞¥ –í–æ–¥–∞",   "name": "water", "sym": "„Ä∞",
     "ansi": "\033[94m",  "trig_h": [2],       "dir": "–°"},    # Kan
]

# –¢—Ä–∏–≥—Ä–∞–º–º–∞ ‚Üí —ç–ª–µ–º–µ–Ω—Ç
TRIG_TO_ELEM: dict[int, int] = {}
for _eid, _ed in enumerate(ELEM_DATA):
    for _t in _ed["trig_h"]:
        TRIG_TO_ELEM[_t] = _eid

# –¢—Ä–∏–≥—Ä–∞–º–º–∞ ‚Üí —Å–∏–º–≤–æ–ª
TRIG_SYMS = {0: "‚ò∑", 1: "‚ò≥", 2: "‚òµ", 3: "‚ò±", 4: "‚ò∂", 5: "‚ò≤", 6: "‚ò¥", 7: "‚ò∞"}
TRIG_NAMES = {0: "–ö—É–Ω—å", 1: "–ß–∂—ç–Ω—å", 2: "–ö–∞–Ω—å", 3: "–î—É–π",
              4: "–ì—ç–Ω—å",  5: "–õ–∏",     6: "–°—é–Ω—å",  7: "–¶—è–Ω—å"}

# –î–∏–Ω–∞–º–∏–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
DYN_SAME    = "same"    # –Ω–∏–∂–Ω. = –≤–µ—Ä—Ö–Ω.
DYN_GEN     = "gen"     # –Ω–∏–∂–Ω. –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –≤–µ—Ä—Ö–Ω.
DYN_REVGEN  = "revgen"  # –≤–µ—Ä—Ö–Ω. –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –Ω–∏–∂–Ω.
DYN_CTRL    = "ctrl"    # –Ω–∏–∂–Ω. –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤–µ—Ä—Ö–Ω.
DYN_REVCTRL = "revctrl" # –≤–µ—Ä—Ö–Ω. –ø–æ–¥–∞–≤–ª—è–µ—Ç –Ω–∏–∂–Ω.

DYN_DATA = {
    DYN_SAME:    {"name": "ÂêåÊ∞£ –ï–¥–∏–Ω—Å—Ç–≤–æ",   "short": "Âêå", "ansi": "\033[92m"},
    DYN_GEN:     {"name": "Áîü –†–æ–∂–¥–µ–Ω–∏–µ",      "short": "Áîü", "ansi": "\033[96m"},
    DYN_REVGEN:  {"name": "ÂèçÁîü –ü–∏—Ç–∞–Ω–∏–µ",     "short": "‚ÜëÁîü","ansi": "\033[95m"},
    DYN_CTRL:    {"name": "ÂÖã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",    "short": "ÂÖã", "ansi": "\033[93m"},
    DYN_REVCTRL: {"name": "ÂèçÂÖã –ü—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ", "short": "‚ÜëÂÖã","ansi": "\033[91m"},
}


# ---------------------------------------------------------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
# ---------------------------------------------------------------------------

def elem_of_trig(t: int) -> int:
    return TRIG_TO_ELEM[t]


def hex_dynamics(h: int) -> tuple[int, int, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (lower_elem, upper_elem, dynamics_key) –¥–ª—è –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã h.
    """
    lo = h & 7
    up = (h >> 3) & 7
    le = elem_of_trig(lo)
    ue = elem_of_trig(up)
    if le == ue:
        dyn = DYN_SAME
    elif (le + 1) % 5 == ue:
        dyn = DYN_GEN
    elif (ue + 1) % 5 == le:
        dyn = DYN_REVGEN
    elif (le + 2) % 5 == ue:
        dyn = DYN_CTRL
    elif (ue + 2) % 5 == le:
        dyn = DYN_REVCTRL
    else:
        dyn = DYN_SAME  # fallback (–Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∏—Ç—å—Å—è)
    return le, ue, dyn


def hex_elem_str(h: int, use_color: bool = True) -> str:
    le, ue, dyn = hex_dynamics(h)
    hx = Hexagram(h)
    d  = DYN_DATA[dyn]
    yc = YANG_ANSI[hx.yang] if use_color else ""
    ac = d["ansi"] if use_color else ""
    lc = ELEM_DATA[le]["ansi"] if use_color else ""
    uc = ELEM_DATA[ue]["ansi"] if use_color else ""
    r  = RESET if use_color else ""
    return (
        f"{yc}{hx.sym}{r} "
        f"{lc}{ELEM_DATA[le]['name_cn'][:1]}{r}"
        f"‚Üí"
        f"{uc}{ELEM_DATA[ue]['name_cn'][:1]}{r}"
        f" {ac}{d['short']}{r}"
    )


# ---------------------------------------------------------------------------
# –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã
# ---------------------------------------------------------------------------

def show_overview(use_color: bool = True) -> str:
    bold = BOLD if use_color else ""
    r    = RESET if use_color else ""
    dim  = DIM   if use_color else ""

    lines = [
        "",
        "‚ïê"*64,
        f"  {bold}‰∫îË°å W«ì X√çNG ‚Äî –ü–Ø–¢–¨ –ü–ï–†–í–û–≠–õ–ï–ú–ï–ù–¢–û–í –í Q6{r}",
        "‚ïê"*64,
        "",
        f"  {bold}–¢—Ä–∏–≥—Ä–∞–º–º—ã –∏ —ç–ª–µ–º–µ–Ω—Ç—ã:{r}",
        "",
    ]

    for eid, ed in enumerate(ELEM_DATA):
        ac  = ed["ansi"] if use_color else ""
        trigs = "  ".join(f"{TRIG_SYMS[t]} {TRIG_NAMES[t]}" for t in ed["trig_h"])
        lines.append(f"  {ac}{ed['name_cn']:<12}{r}  {trigs}")
    lines.append("")

    # –¶–∏–∫–ª—ã
    gen_str  = " ‚Üí ".join(ed["name_cn"][:1] for ed in ELEM_DATA) + " ‚Üí ..."
    ctrl_str = " ‚Üí ".join(ELEM_DATA[i]["name_cn"][:1]
                          for i in [0, 2, 4, 1, 3]) + " ‚Üí ..."

    lines += [
        f"  {bold}–¶–∏–∫–ª –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—è (Áõ∏Áîü):{r}",
        f"  {GRN if use_color else ''}{gen_str}{r}",
        "",
        f"  {bold}–¶–∏–∫–ª –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è (Áõ∏ÂÖã):{r}",
        f"  {RED if use_color else ''}{ctrl_str}{r}",
        "",
    ]

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    dyn_counts: dict[str, int] = defaultdict(int)
    for h in range(64):
        _, _, dyn = hex_dynamics(h)
        dyn_counts[dyn] += 1

    lines += [
        f"  {bold}–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ 64 –≥–µ–∫—Å–∞–≥—Ä–∞–º–º –ø–æ –¥–∏–Ω–∞–º–∏–∫–∞–º:{r}",
        "",
    ]
    for key in [DYN_SAME, DYN_GEN, DYN_REVGEN, DYN_CTRL, DYN_REVCTRL]:
        d  = DYN_DATA[key]
        ac = d["ansi"] if use_color else ""
        bar = "‚ñà" * dyn_counts[key]
        lines.append(
            f"  {ac}{d['name']:<25}{r}  {dyn_counts[key]:>2}  {bar}"
        )
    lines.append("")
    return "\n".join(lines)


# ---------------------------------------------------------------------------
# –¢–∞–±–ª–∏—Ü–∞ 5√ó5 –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
# ---------------------------------------------------------------------------

def show_matrix(use_color: bool = True) -> str:
    bold = BOLD if use_color else ""
    r    = RESET if use_color else ""
    dim  = DIM   if use_color else ""

    # –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É
    matrix = [[[] for _ in range(5)] for _ in range(5)]
    for h in range(64):
        le, ue, _ = hex_dynamics(h)
        matrix[le][ue].append(h)

    lines = [
        f"  {bold}–ú–∞—Ç—Ä–∏—Ü–∞ 5√ó5: –Ω–∏–∂–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ (—Å—Ç—Ä–æ–∫–∏) √ó –≤–µ—Ä—Ö–Ω—è—è (—Å—Ç–æ–ª–±—Ü—ã){r}",
        f"  {dim}–ß–∏—Å–ª–æ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º –≤ –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ (–Ω–∏–∂–Ω.‚Üí –≤–µ—Ä—Ö–Ω. –ø–æ —Ü–∏–∫–ª–∞–º){r}",
        "",
    ]

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
    header = "         " + "  ".join(
        f"{(ELEM_DATA[e]['ansi'] if use_color else '')}{ELEM_DATA[e]['name_cn'][:1]}{r:>3}"
        for e in range(5)
    )
    lines.append(header)
    lines.append("  " + "‚îÄ"*40)

    for lo_e in range(5):
        ed_lo = ELEM_DATA[lo_e]
        lc    = ed_lo["ansi"] if use_color else ""
        row   = f"  {lc}{ed_lo['name_cn'][:1]}{r}  "
        for hi_e in range(5):
            cell = matrix[lo_e][hi_e]
            dyn  = hex_dynamics(cell[0])[2] if cell else DYN_SAME
            ac   = DYN_DATA[dyn]["ansi"] if use_color else ""
            row += f"  {ac}{len(cell):>2}{r}"
        row += f"   {lc}{ed_lo['name_cn']}{r}"
        lines.append(row)

    lines += [
        "",
        f"  {dim}–î–∏–∞–≥–æ–Ω–∞–ª—å (Âêå –ï–¥–∏–Ω—Å—Ç–≤–æ): –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–µ—Ä—Ö/–Ω–∏–∑{r}",
        f"  {DYN_DATA[DYN_GEN]['ansi'] if use_color else ''}"
        f"–ù–∞–¥–∏–∞–≥–æ–Ω–∞–ª—å –ø–æ —Ü–∏–∫–ª—É –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—è = Áîü –†–æ–∂–¥–µ–Ω–∏–µ{r}",
        f"  {DYN_DATA[DYN_CTRL]['ansi'] if use_color else ''}"
        f"–ß–µ—Ä–µ–∑ –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é = ÂÖã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ{r}",
    ]
    return "\n".join(lines)


# ---------------------------------------------------------------------------
# –í—Å–µ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã –ø–æ –¥–∏–Ω–∞–º–∏–∫–∞–º
# ---------------------------------------------------------------------------

def show_by_dynamics(dyn_key: str | None = None, use_color: bool = True) -> str:
    bold = BOLD if use_color else ""
    r    = RESET if use_color else ""
    dim  = DIM   if use_color else ""

    groups: dict[str, list[int]] = defaultdict(list)
    for h in range(64):
        _, _, dyn = hex_dynamics(h)
        groups[dyn].append(h)

    keys = [dyn_key] if dyn_key else [DYN_SAME, DYN_GEN, DYN_REVGEN, DYN_CTRL, DYN_REVCTRL]
    lines = []

    for key in keys:
        d    = DYN_DATA[key]
        ac   = d["ansi"] if use_color else ""
        hs   = groups[key]
        lines += [
            f"  {ac}{bold}{d['name']}  ({len(hs)} –≥–µ–∫—Å–∞–≥—Ä–∞–º–º){r}",
            "",
        ]
        for h in hs:
            le, ue, _ = hex_dynamics(h)
            hx = Hexagram(h)
            yc = YANG_ANSI[hx.yang] if use_color else ""
            lc = ELEM_DATA[le]["ansi"] if use_color else ""
            uc = ELEM_DATA[ue]["ansi"] if use_color else ""
            lines.append(
                f"  {yc}{hx.sym} –ö–í#{hx.kw:>2} ¬´{hx.name_pin}¬ª{r}  "
                f"{lc}{ELEM_DATA[le]['name_cn']}{r} "
                f"{ac}‚Üí{r} "
                f"{uc}{ELEM_DATA[ue]['name_cn']}{r}"
            )
        lines.append("")

    return "\n".join(lines)


# ---------------------------------------------------------------------------
# –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–π –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã
# ---------------------------------------------------------------------------

def show_hexagram(h: int, use_color: bool = True) -> str:
    bold = BOLD if use_color else ""
    r    = RESET if use_color else ""
    dim  = DIM   if use_color else ""

    hx = Hexagram(h)
    lo = h & 7
    up = (h >> 3) & 7
    le, ue, dyn = hex_dynamics(h)
    ed_lo = ELEM_DATA[le]
    ed_up = ELEM_DATA[ue]
    d     = DYN_DATA[dyn]

    yc  = YANG_ANSI[hx.yang] if use_color else ""
    lc  = ed_lo["ansi"] if use_color else ""
    uc  = ed_up["ansi"] if use_color else ""
    ac  = d["ansi"] if use_color else ""

    DYN_DESC = {
        DYN_SAME:    "–ù–∏–∂–Ω—è—è –∏ –≤–µ—Ä—Ö–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º—ã –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ ‚Äî –≥–∞—Ä–º–æ–Ω–∏—è –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.",
        DYN_GEN:     "–ù–∏–∂–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –≤–µ—Ä—Ö–Ω—é—é ‚Äî —Ä–æ—Å—Ç, —Ä–∞–∑–≤–∏—Ç–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–ª–µ–¥—É—é—â—É—é —Ñ–∞–∑—É.",
        DYN_REVGEN:  "–í–µ—Ä—Ö–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –Ω–∏–∂–Ω—é—é ‚Äî –ø–∏—Ç–∞–Ω–∏–µ, –æ–ø–æ—Ä–∞, –≤–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ç–æ–∫—É.",
        DYN_CTRL:    "–ù–∏–∂–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤–µ—Ä—Ö–Ω—é—é ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.",
        DYN_REVCTRL: "–í–µ—Ä—Ö–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞ –ø–æ–¥–∞–≤–ª—è–µ—Ç –Ω–∏–∂–Ω—é—é ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ, –∏—Å–ø—ã—Ç–∞–Ω–∏–µ.",
    }

    lines = [
        "",
        f"  {yc}{hx.sym} –ö–í#{hx.kw} ¬´{hx.name_cn} {hx.name_pin}¬ª  h={h}  —è–Ω={hx.yang}{r}",
        "",
        f"  –ù–∏–∂–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞: {TRIG_SYMS[lo]} {TRIG_NAMES[lo]:>7}  ‚Üí  "
        f"{lc}{ed_lo['name_cn']}{r}",
        f"  –í–µ—Ä—Ö–Ω—è—è —Ç—Ä–∏–≥—Ä–∞–º–º–∞: {TRIG_SYMS[up]} {TRIG_NAMES[up]:>7}  ‚Üí  "
        f"{uc}{ed_up['name_cn']}{r}",
        "",
        f"  –î–∏–Ω–∞–º–∏–∫–∞:  {ac}{d['name']}{r}",
        f"  {dim}{DYN_DESC[dyn]}{r}",
        "",
    ]

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    if dyn != DYN_SAME:
        gen_next_of_lo = ELEM_DATA[(le + 1) % 5]["name_cn"]
        ctrl_next_of_lo = ELEM_DATA[(le + 2) % 5]["name_cn"]
        lines += [
            f"  {dim}–ò–∑ {ed_lo['name_cn']}: –ø–æ—Ä–æ–∂–¥–∞–µ—Ç {gen_next_of_lo}, "
            f"–ø–æ–¥–∞–≤–ª—è–µ—Ç {ctrl_next_of_lo}{r}",
        ]

    return "\n".join(lines)


# ---------------------------------------------------------------------------
# –ü—É—Ç—å –ø–æ —Ü–∏–∫–ª—É –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—è / –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è
# ---------------------------------------------------------------------------

def show_cycle_path(start_elem: int, n_steps: int = 5,
                     use_cycle: str = "gen", use_color: bool = True) -> str:
    bold = BOLD if use_color else ""
    r    = RESET if use_color else ""

    step  = 1 if use_cycle == "gen" else 2
    cycle_name = "–ø–æ—Ä–æ–∂–¥–µ–Ω–∏—è (Áõ∏Áîü)" if use_cycle == "gen" else "–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è (Áõ∏ÂÖã)"
    lines = [
        f"  {bold}–¶–∏–∫–ª {cycle_name} –æ—Ç {ELEM_DATA[start_elem]['name_cn']}:{r}",
        "",
    ]
    elem = start_elem
    for i in range(n_steps + 1):
        ed = ELEM_DATA[elem]
        ac = ed["ansi"] if use_color else ""
        trigs_str = " ".join(f"{TRIG_SYMS[t]}{TRIG_NAMES[t]}" for t in ed["trig_h"])
        marker = " ‚Üê —Å—Ç–∞—Ä—Ç" if i == 0 else ""
        lines.append(f"  {ac}{ed['name_cn']:<14}{r}  {trigs_str}{marker}")
        if i < n_steps:
            arrow = " ‚Üí" if use_color else " ->"
            lines.append(f"  {arrow}")
        elem = (elem + step) % 5

    return "\n".join(lines)


# ---------------------------------------------------------------------------
# CLI
# ---------------------------------------------------------------------------

def main():
    parser = argparse.ArgumentParser(
        description="hexwuxing ‚Äî ‰∫îË°å: –ø—è—Ç—å –ø–µ—Ä–≤–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º–∞—Ö",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
–ü—Ä–∏–º–µ—Ä—ã:
  python hexwuxing.py              –û–±–∑–æ—Ä: —ç–ª–µ–º–µ–Ω—Ç—ã, —Ü–∏–∫–ª—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  python hexwuxing.py --matrix     –ú–∞—Ç—Ä–∏—Ü–∞ 5√ó5 –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
  python hexwuxing.py --same       –í—Å–µ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã –µ–¥–∏–Ω—Å—Ç–≤–∞ (ÂêåÊ∞£)
  python hexwuxing.py --gen        –í—Å–µ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã —Ä–æ–∂–¥–µ–Ω–∏—è (Áîü)
  python hexwuxing.py --ctrl       –í—Å–µ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (ÂÖã)
  python hexwuxing.py --all        –í—Å–µ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã –ø–æ –¥–∏–Ω–∞–º–∏–∫–∞–º
  python hexwuxing.py --h 7        –ê–Ω–∞–ª–∏–∑ –≥–µ–∫—Å–∞–≥—Ä–∞–º–º—ã h=7 (–¢–∞–π)
  python hexwuxing.py --cycle gen  –¶–∏–∫–ª –ø–æ—Ä–æ–∂–¥–µ–Ω–∏—è –æ—Ç –î–µ—Ä–µ–≤–∞
  python hexwuxing.py --cycle ctrl –¶–∏–∫–ª –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ—Ä–µ–≤–∞
        """,
    )
    parser.add_argument("--matrix",   action="store_true")
    parser.add_argument("--same",     action="store_true")
    parser.add_argument("--gen",      action="store_true")
    parser.add_argument("--ctrl",     action="store_true")
    parser.add_argument("--all",      action="store_true")
    parser.add_argument("--h",        type=int, metavar="N")
    parser.add_argument("--cycle",    type=str, choices=["gen", "ctrl"])
    parser.add_argument("--no-color", action="store_true")
    args = parser.parse_args()
    use_color = not args.no_color

    if args.matrix:
        print()
        print(show_matrix(use_color))
    elif args.same:
        print()
        print(show_by_dynamics(DYN_SAME, use_color))
    elif args.gen:
        print()
        print(show_by_dynamics(DYN_GEN, use_color))
    elif args.ctrl:
        print()
        print(show_by_dynamics(DYN_CTRL, use_color))
    elif args.all:
        print()
        print(show_by_dynamics(None, use_color))
    elif args.h is not None:
        if not 0 <= args.h <= 63:
            print("–û—à–∏–±–∫–∞: h –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0..63")
            return
        print(show_hexagram(args.h, use_color))
    elif args.cycle:
        print()
        print(show_cycle_path(0, 5, args.cycle, use_color))
    else:
        print(show_overview(use_color))


if __name__ == "__main__":
    main()
